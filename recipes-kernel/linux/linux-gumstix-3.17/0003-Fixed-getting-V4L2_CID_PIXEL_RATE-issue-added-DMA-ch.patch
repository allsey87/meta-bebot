From cbdcbb56a40488b910bde14f9de0f9d4139c6d67 Mon Sep 17 00:00:00 2001
From: Michael Allwright <allsey87@gmail.com>
Date: Mon, 8 Jun 2015 10:51:24 +0200
Subject: [PATCH] Fixed getting V4L2_CID_PIXEL_RATE issue, added DMA channels
 to DT

---
 arch/arm/boot/dts/omap4-duovero-bebot.dts |  2 ++
 drivers/staging/media/omap4iss/iss.c      | 29 ++++++++++++++++++++---------
 2 files changed, 22 insertions(+), 9 deletions(-)

diff --git a/arch/arm/boot/dts/omap4-duovero-bebot.dts b/arch/arm/boot/dts/omap4-duovero-bebot.dts
index 682e5ca..f9fb013 100644
--- a/arch/arm/boot/dts/omap4-duovero-bebot.dts
+++ b/arch/arm/boot/dts/omap4-duovero-bebot.dts
@@ -85,6 +85,8 @@
 			interrupts = <GIC_SPI 24 IRQ_TYPE_LEVEL_HIGH>;
 			//clocks = <&ducati_clk_mux_ck>, <&iss_ctrlclk>;
 			//clock-names = "fck", "iss_ctrlclk";
+			dmas = <&sdma 9>, <&sdma 10>, <&sdma 12>, <&sdma 13>;
+			dma-names = "1", "2", "3", "4";
 
 		        csi21: csi2 {
 				endpoint {
diff --git a/drivers/staging/media/omap4iss/iss.c b/drivers/staging/media/omap4iss/iss.c
index be9f8a2..54ac2be 100644
--- a/drivers/staging/media/omap4iss/iss.c
+++ b/drivers/staging/media/omap4iss/iss.c
@@ -184,7 +184,10 @@ int omap4iss_get_external_info(struct iss_pipeline *pipe,
 	struct iss_device *iss =
 		container_of(pipe, struct iss_video, pipe)->iss;
 	struct v4l2_subdev_format fmt;
-	struct v4l2_ctrl *ctrl;
+
+	struct v4l2_ext_controls ctrls;
+	struct v4l2_ext_control ctrl;
+
 	int ret;
 
 	if (!pipe->external)
@@ -204,15 +207,22 @@ int omap4iss_get_external_info(struct iss_pipeline *pipe,
 
 	pipe->external_bpp = omap4iss_video_format_info(fmt.format.code)->bpp;
 
-	ctrl = v4l2_ctrl_find(pipe->external->ctrl_handler,
-			      V4L2_CID_PIXEL_RATE);
-	if (ctrl == NULL) {
-		dev_warn(iss->dev, "no pixel rate control in subdev %s\n",
+	memset(&ctrls, 0, sizeof(ctrls));
+	memset(&ctrl, 0, sizeof(ctrl));
+
+	ctrl.id = V4L2_CID_PIXEL_RATE;
+	ctrls.count = 1;
+	ctrls.controls = &ctrl;
+
+	ret = v4l2_g_ext_ctrls(pipe->external->ctrl_handler, &ctrls);
+	if (ret < 0) {
+		dev_warn(iss->dev, "no pixel rate control in subdev %s\n", 
 			 pipe->external->name);
-		return -EPIPE;
+		return ret;
 	}
-
-	pipe->external_rate = v4l2_ctrl_g_ctrl_int64(ctrl);
+	pipe->external_rate = ctrl.value64;
+	dev_info(iss->dev, "subdev %s pixel rate = %lu\n", 
+		 pipe->external->name, pipe->external_rate);
 
 	return 0;
 }
@@ -1212,6 +1222,7 @@ static int iss_subdev_notifier_bound(struct v4l2_async_notifier *notifier,
 	*/
 	v4l2_info(&iss->v4l2_dev, "Creating link");
 	ret = media_entity_create_link(&sensor->entity, 0, input, pad, flags);
+	sensor->host_priv = iss_subdevs;
 
 	if(ret < 0) {
 		v4l2_info(&iss->v4l2_dev, "Creating link failed!");
@@ -1452,11 +1463,11 @@ static int iss_probe(struct platform_device *pdev)
 
 	platform_set_drvdata(pdev, iss);
 
-	/* Clocks */
 	ret = iss_map_mem_resource(pdev, iss, OMAP4_ISS_MEM_TOP);
 	if (ret < 0)
 		goto error;
 
+	/* Clocks */
 	ret = iss_get_clocks(iss);
 	if (ret < 0)
 		goto error;
-- 
1.9.1

